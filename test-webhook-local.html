<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Local de Webhook</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h2 {
            color: #555;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .webhook-url {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            transition: background 0.3s;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .response-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .status-info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .info-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .info-label {
            font-weight: bold;
            color: #495057;
        }
        .info-value {
            color: #6c757d;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste Local de Webhook - n8n</h1>
        
        <div class="section">
            <h2>Configura√ß√£o</h2>
            <input type="url" id="webhook-url" class="webhook-url" 
                   value="https://n8n.avauto.fun/webhook/eab92d5a-c6ee-4c74-9b52-e89997dd4205"
                   placeholder="URL do webhook">
            <button class="test-button" onclick="sendWebhookTest()" id="test-btn">
                üöÄ Enviar Teste
            </button>
            <button class="test-button" onclick="clearResults()" style="background: #6c757d;">
                üóëÔ∏è Limpar
            </button>
            <button class="test-button" onclick="showCurlCommand()" style="background: #28a745;">
                üìã Gerar cURL
            </button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Enviando requisi√ß√£o para o webhook...</p>
        </div>

        <div class="section">
            <h2>Payload Enviado</h2>
            <div class="code-block" id="payload-display">
                Clique em "Enviar Teste" para ver o payload...
            </div>
        </div>

        <div class="section">
            <h2>Resposta do Webhook</h2>
            <div class="response-block" id="response-display">
                Aguardando resposta...
            </div>
            
            <div class="info-grid" id="response-info" style="display: none;">
                <div class="info-item">
                    <div class="info-label">Status HTTP:</div>
                    <div class="info-value" id="http-status">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Tempo de Resposta:</div>
                    <div class="info-value" id="response-time">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Content-Type:</div>
                    <div class="info-value" id="content-type">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Timestamp:</div>
                    <div class="info-value" id="timestamp">-</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Payload de teste exato que voc√™ forneceu
        const testPayload = {
            "checkType": "availability",
            "webhookUrl": "https://n8n.avauto.fun/webhook-test/eab92d5a-c6ee-4c74-9b52-e89997dd4205",
            "requestTimestamp": "2025-07-05T23:35:17.798Z",
            "quoteId": "4a2d379d-3e3d-4b77-887d-0772af1ae858",
            "slug": "quote-4a2d379d-3e3d-4b77-887d-0772af1ae858",
            "clientName": "Multicamhd",
            "clientEmail": "multicamhd@gmail.com",
            "projectName": "teste2",
            "shootingDate": "2025-07-14",
            "quoteData": {
                "id": "4a2d379d-3e3d-4b77-887d-0772af1ae858",
                "user_id": "ef32731a-54fc-48de-baf3-7bbec73040af",
                "created_at": "2025-07-05T23:23:42.386734+00:00",
                "updated_at": "2025-07-05T23:23:42.386734+00:00",
                "status": "approved",
                "project_name": "teste2",
                "client_name": "Multicamhd",
                "client_company": "multicamh",
                "client_email": "multicamhd@gmail.com",
                "client_phone": "19981454647",
                "shooting_dates_start": "2025-07-14",
                "shooting_dates_end": "2025-07-17",
                "days_count": 4,
                "led_configuration": {
                    "principal": {
                        "width": "20",
                        "height": "5",
                        "curvature": 5,
                        "modules": 400,
                        "resolution": "",
                        "pixels_width": 7680,
                        "pixels_height": 1920,
                        "total_pixels": 14745600,
                        "power_max": "69000",
                        "power_avg": "23000",
                        "weight": "3000"
                    },
                    "teto": {
                        "width": "8",
                        "height": "6",
                        "modules": 192,
                        "pixels_width": 3072,
                        "pixels_height": 2304,
                        "total_pixels": 7077888,
                        "power_max": "33120",
                        "power_avg": "11040",
                        "weight": "1440",
                        "resolution": ""
                    }
                },
                "production_type": {
                    "selected_pod_type": "2d",
                    "studio_size": null
                },
                "pricing": {
                    "daily_rate": "101140",
                    "discounted_daily_rate": null,
                    "total_price": "R$ 262.964,00",
                    "original_total_price": "404560",
                    "discount_percentage": "35",
                    "discount_amount": "141596.00",
                    "discount_reason": null,
                    "total_discount_percentage": "0.00",
                    "total_discount_amount": "0.00"
                },
                "equipment_pricing": {
                    "price_modules_principal": null,
                    "price_processors_principal": null,
                    "price_server": null,
                    "price_server_backup": false,
                    "price_disguise_modules_led": null,
                    "price_disguise_mx40_pro": null,
                    "price_disguise_vx4n": null,
                    "price_rxii": null,
                    "price_tracking": null,
                    "price_cinebot": null,
                    "price_trilho": null,
                    "price_komodo": null,
                    "total_price_estudios": null,
                    "total_price_2d": null,
                    "total_price_3d": null,
                    "total_price_rube_draco": null
                },
                "selected_services": [
                    {
                        "name": "M√≥dulos LED (592 Unidades)",
                        "quantity": 592,
                        "unit_price": 85,
                        "daily_subtotal": 50320,
                        "total_subtotal": 201280
                    },
                    {
                        "name": "Processadores MX-40 Pro",
                        "quantity": 2,
                        "unit_price": 1890,
                        "daily_subtotal": 3780,
                        "total_subtotal": 15120
                    },
                    {
                        "name": "Disguise VX4n",
                        "quantity": 1,
                        "unit_price": 10000,
                        "daily_subtotal": 10000,
                        "total_subtotal": 40000
                    },
                    {
                        "name": "Disguise RXII",
                        "quantity": 3,
                        "unit_price": 7750,
                        "daily_subtotal": 23250,
                        "total_subtotal": 93000
                    },
                    {
                        "name": "Stype Tracking",
                        "quantity": 1,
                        "unit_price": 3890,
                        "daily_subtotal": 3890,
                        "total_subtotal": 15560
                    },
                    {
                        "name": "Equipe especializada Disguise",
                        "quantity": 1,
                        "unit_price": 9900,
                        "daily_subtotal": 9900,
                        "total_subtotal": 39600
                    }
                ],
                "approval_details": {
                    "quote_approved": true,
                    "quote_approved_at": "2025-07-05T23:35:17.798924+00:00",
                    "quote_approval_ip": "179.160.124.111",
                    "approved_by": "client"
                },
                "metadata": {
                    "discount_description": null,
                    "last_modified_at": "2025-07-05T23:23:42.386734",
                    "last_modified_by": null,
                    "sales_rep_id": null,
                    "sales_rep_name": null,
                    "lead_id": null,
                    "quote_url_slug": null,
                    "modified": "2025-07-05T23:35:17.798924"
                }
            },
            "calculated_totals": {
                "daily_equipment_total": 101140,
                "total_before_discount": 404560,
                "discount_amount": 141596,
                "final_total": 262964,
                "final_total_formatted": "R$ 262.964,00",
                "total_days": 4,
                "discount_percentage": 35
            },
            "studio_requirements": {
                "led_total_modules": 592,
                "led_total_pixels": 21823488,
                "total_power_consumption": {
                    "max_watts": 102120,
                    "avg_watts": 34040
                },
                "total_weight_kg": 4440,
                "space_requirements": {
                    "principal_area_sqm": 100,
                    "teto_area_sqm": 48,
                    "total_led_area_sqm": 148
                }
            },
            "calendar_check": {
                "requested_start_date": "2025-07-14",
                "requested_end_date": "2025-07-17",
                "duration_days": 4,
                "check_type": "studio_availability",
                "timezone": "America/Sao_Paulo"
            }
        };

        // Fun√ß√£o para enviar o teste
        async function sendWebhookTest() {
            const webhookUrl = document.getElementById('webhook-url').value;
            const loadingDiv = document.getElementById('loading');
            const testBtn = document.getElementById('test-btn');
            const payloadDisplay = document.getElementById('payload-display');
            const responseDisplay = document.getElementById('response-display');
            const responseInfo = document.getElementById('response-info');

            if (!webhookUrl) {
                alert('Por favor, insira uma URL de webhook v√°lida.');
                return;
            }

            // Atualizar timestamp para o momento atual
            const currentPayload = {
                ...testPayload,
                requestTimestamp: new Date().toISOString(),
                webhookUrl: webhookUrl
            };

            // Mostrar payload
            payloadDisplay.textContent = JSON.stringify(currentPayload, null, 2);

            // Mostrar loading
            loadingDiv.style.display = 'block';
            testBtn.disabled = true;
            responseDisplay.textContent = 'Enviando requisi√ß√£o...';
            responseDisplay.className = 'response-block';
            responseInfo.style.display = 'none';

            const startTime = Date.now();

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(currentPayload)
                });

                const endTime = Date.now();
                const responseTime = endTime - startTime;

                // Tentar fazer parse da resposta
                let responseData;
                let contentType = response.headers.get('content-type') || 'text/plain';
                
                try {
                    // Clone the response so we can read it multiple times if needed
                    const responseClone = response.clone();
                    
                    if (contentType.includes('application/json')) {
                        responseData = await response.json();
                        responseDisplay.textContent = JSON.stringify(responseData, null, 2);
                    } else {
                        responseData = await response.text();
                        responseDisplay.textContent = responseData;
                    }
                } catch (parseError) {
                    console.error('Parse error:', parseError);
                    try {
                        // Try to read as text if JSON parsing failed
                        const responseClone = response.clone();
                        responseData = await responseClone.text();
                        responseDisplay.textContent = `Resposta recebida (n√£o √© JSON v√°lido):\n${responseData}`;
                    } catch (textError) {
                        responseDisplay.textContent = `Erro ao ler resposta:\n${parseError.message}`;
                    }
                }

                // Atualizar classe do response display baseado no status
                if (response.ok) {
                    responseDisplay.className = 'response-block status-success';
                } else {
                    responseDisplay.className = 'response-block status-error';
                }

                // Mostrar informa√ß√µes da resposta
                document.getElementById('http-status').textContent = `${response.status} ${response.statusText}`;
                document.getElementById('response-time').textContent = `${responseTime}ms`;
                document.getElementById('content-type').textContent = contentType;
                document.getElementById('timestamp').textContent = new Date().toLocaleString('pt-BR');
                responseInfo.style.display = 'grid';

            } catch (error) {
                console.error('Erro ao enviar webhook:', error);
                
                let errorMessage = `‚ùå Erro de rede:\n${error.message}\n\n`;
                
                // Provide specific error messages
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage += `Poss√≠veis causas:\n- CORS bloqueado pelo servidor n8n\n- Webhook URL incorreta\n- Servidor indispon√≠vel\n\n`;
                    errorMessage += `üí° Dica: Se o webhook funciona via Postman/curl mas n√£o no browser,\no problema √© CORS. O servidor n8n precisa permitir requisi√ß√µes do browser.`;
                } else if (error.message.includes('body stream already read')) {
                    errorMessage += `Erro de parsing da resposta. O webhook respondeu mas houve problema\nao ler a resposta. Isso geralmente significa que o webhook est√° funcionando.`;
                } else {
                    errorMessage += `Poss√≠veis causas:\n- Webhook indispon√≠vel\n- Problema de conectividade\n- Timeout da requisi√ß√£o\n- Problema de rede local`;
                }
                
                responseDisplay.textContent = errorMessage;
                responseDisplay.className = 'response-block status-error';
                
                // Mostrar info de erro
                document.getElementById('http-status').textContent = `Erro: ${error.name}`;
                document.getElementById('response-time').textContent = `${Date.now() - startTime}ms`;
                document.getElementById('content-type').textContent = 'N/A';
                document.getElementById('timestamp').textContent = new Date().toLocaleString('pt-BR');
                responseInfo.style.display = 'grid';
            } finally {
                loadingDiv.style.display = 'none';
                testBtn.disabled = false;
            }
        }

        // Fun√ß√£o para limpar resultados
        function clearResults() {
            document.getElementById('payload-display').textContent = 'Clique em "Enviar Teste" para ver o payload...';
            document.getElementById('response-display').textContent = 'Aguardando resposta...';
            document.getElementById('response-display').className = 'response-block';
            document.getElementById('response-info').style.display = 'none';
        }

        // Fun√ß√£o para mostrar comando cURL
        function showCurlCommand() {
            const webhookUrl = document.getElementById('webhook-url').value;
            const currentPayload = {
                ...testPayload,
                requestTimestamp: new Date().toISOString(),
                webhookUrl: webhookUrl
            };
            
            const curlCommand = `curl -X POST "${webhookUrl}" \\
  -H "Content-Type: application/json" \\
  -d '${JSON.stringify(currentPayload, null, 2).replace(/'/g, "'\\''")}' \\
  --connect-timeout 30 \\
  --max-time 60 \\
  -v`;
            
            // Mostrar o comando em uma nova janela ou copiar para clipboard
            const newWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            newWindow.document.write(`
                <html>
                <head><title>Comando cURL para Teste</title></head>
                <body style="font-family: monospace; padding: 20px; background: #f5f5f5;">
                    <h2>Comando cURL para Testar o Webhook</h2>
                    <p>Copy e cole este comando no terminal/prompt de comando:</p>
                    <textarea style="width: 100%; height: 400px; font-family: monospace; font-size: 12px;">${curlCommand}</textarea>
                    <p><button onclick="navigator.clipboard.writeText(\`${curlCommand.replace(/`/g, '\\`')}\`)">üìã Copiar</button></p>
                    <p><strong>Nota:</strong> Este teste bypass CORS e mostra se o webhook est√° funcionando.</p>
                </body>
                </html>
            `);
        }

        // Inicializar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ Teste de Webhook carregado e pronto!');
            console.log('Payload de teste:', testPayload);
        });
    </script>
</body>
</html>